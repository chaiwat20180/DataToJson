<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตัวแปลงข้อมูลเป็น JSON</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
        }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col min-h-screen items-center p-4 sm:p-6 md:p-8">

    <div class="w-full max-w-7xl mx-auto flex flex-col flex-grow">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-white">ตัวแปลงข้อมูลเป็น JSON อัตโนมัติ</h1>
            <p class="text-gray-400 mt-2">วางข้อมูลดิบของคุณทางด้านซ้าย แล้วผลลัพธ์ JSON จะปรากฏทางด้านขวา</p>
        </header>

        <!-- Main Content: Input and Output -->
        <main class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
            <!-- Input Column -->
            <div class="flex flex-col">
                <label for="rawDataInput" class="text-lg font-semibold mb-2 text-gray-300">ข้อมูลดิบ (Input)</label>
                <textarea id="rawDataInput" 
                          class="w-full h-full min-h-[300px] md:min-h-[500px] p-4 bg-gray-800 border border-gray-700 rounded-lg shadow-inner focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none font-mono text-sm"
                          placeholder="วางข้อมูลที่คั่นด้วย | หรือข้อมูล JSON ที่นี่..."></textarea>
            </div>

            <!-- Output Column -->
            <div class="flex flex-col">
                <label for="jsonOutput" class="text-lg font-semibold mb-2 text-gray-300">ผลลัพธ์ (JSON Output)</label>
                <div class="relative w-full h-full min-h-[300px] md:min-h-[500px] bg-gray-800 border border-gray-700 rounded-lg shadow-inner">
                    <pre class="w-full h-full overflow-auto p-4"><code id="jsonOutput" class="font-mono text-sm text-green-300 whitespace-pre-wrap break-all"></code></pre>
                </div>
            </div>
        </main>

        <!-- Action Buttons -->
        <footer class="w-full mt-6 flex justify-center items-center gap-4">
            <button id="copyBtn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-colors duration-200">
                คัดลอก (Copy)
            </button>
            <button id="clearBtn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition-colors duration-200">
                ล้างข้อมูล (Clear)
            </button>
        </footer>
    </div>

    <script>
        $(document).ready(function() {
            // Function to perform the conversion
            function convertToJson() {
                let rawInput = $('#rawDataInput').val();
                const outputElement = $('#jsonOutput');

                if (!rawInput.trim()) {
                    outputElement.text('');
                    return;
                }

                let processedInput = rawInput.trim();

                // --- NEW LOGIC: First, try to parse as-is JSON ---
                try {
                    const parsedJson = JSON.parse(processedInput);
                    // If parsing is successful, it's valid JSON. Just format it.
                    const formattedJson = JSON.stringify(parsedJson, null, 4);
                    outputElement.text(formattedJson);
                    return; // Exit function if successful
                } catch (e) {
                    // Not a valid JSON string, so we'll ignore the error and fall through to the custom logic.
                }


                // --- FALLBACK: Process as pipe-separated string ---
                try {
                    // Pre-process the input to handle common pasting issues.
                    if ((processedInput.startsWith('"') && processedInput.endsWith('"')) || (processedInput.startsWith("'") && processedInput.endsWith("'"))) {
                        processedInput = processedInput.substring(1, processedInput.length - 1);
                    }
                    processedInput = processedInput.replace(/\\r/g, '\r').replace(/\\n/g, '\n').replace(/\\t/g, '\t');

                    const separatorMatch = processedInput.match(/\r\n|\r|\n/);
                    if (!separatorMatch) {
                        outputElement.text(''); // No separator found for pipe-separated logic
                        return;
                    }
                    
                    const separatorIndex = separatorMatch.index;

                    const headerString = processedInput.substring(0, separatorIndex).trim();
                    let valueString = processedInput.substring(separatorIndex + separatorMatch[0].length).trim();
                    
                    const headers = headerString.replace(/^\|+|\|+$/g, '').split('|').map(h => h.trim());
                    
                    const unifiedValueString = valueString.replace(/[\t\s]*\|[\t\s]*/g, '|').replace(/\t/g, '|');
                    const cleanValueString = unifiedValueString.replace(/^\|+|\|+$/g, '');
                    const values = cleanValueString.split('|').map(v => v.trim());

                    // Manually build the output string to allow for duplicate keys visually.
                    const resultLines = [];
                    headers.forEach((key, index) => {
                        if (key) {
                            const value = values[index] || '';
                            const formattedValue = JSON.stringify(value);
                            resultLines.push(`    "${key}": ${formattedValue}`);
                        }
                    });

                    if (resultLines.length > 0) {
                        const outputString = '{\n' + resultLines.join(',\n') + '\n}';
                        outputElement.text(outputString);
                    } else {
                        outputElement.text('');
                    }

                } catch (error) {
                    outputElement.text('เกิดข้อผิดพลาดในการแปลงข้อมูล:\n' + error.message);
                }
            }

            // Event listener for input changes (triggers on paste, cut, typing).
            $('#rawDataInput').on('input', convertToJson);

            // Event listener for the Clear button.
            $('#clearBtn').on('click', function() {
                $('#rawDataInput').val('');
                $('#jsonOutput').text('');
            });

            // Event listener for the Copy button.
            $('#copyBtn').on('click', function() {
                const jsonText = $('#jsonOutput').text();
                if (jsonText) {
                    navigator.clipboard.writeText(jsonText).then(() => {
                        const originalText = $(this).text();
                        $(this).text('คัดลอกแล้ว! (Copied!)');
                        setTimeout(() => {
                            $(this).text(originalText);
                        }, 2000);
                    }).catch(err => {
                        console.error('ไม่สามารถคัดลอกได้: ', err);
                        const textArea = document.createElement("textarea");
                        textArea.value = jsonText;
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            const originalText = $(this).text();
                            $(this).text('คัดลอกแล้ว! (Copied!)');
                            setTimeout(() => {
                                $(this).text(originalText);
                            }, 2000);
                        } catch (err) {
                            alert('ขออภัย, ไม่สามารถคัดลอกได้');
                        }
                        document.body.removeChild(textArea);
                    });
                }
            });

            // Trigger conversion on load just in case there's text from browser cache.
            convertToJson();
        });
    </script>

</body>
</html>
